<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goal Portfolio Viewer - Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background: #f3f4f6;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- Enable demo mode -->
    <script>
        window.__GPV_DEMO_MODE__ = true;
    </script>
    
    <!-- Mock Tampermonkey API -->
    <script>
        const mockStorage = {};
        
        window.GM_setValue = function(key, value) {
            mockStorage[key] = value;
        };
        
        window.GM_getValue = function(key, defaultValue) {
            return mockStorage.hasOwnProperty(key) ? mockStorage[key] : defaultValue;
        };
        
        window.GM_deleteValue = function(key) {
            delete mockStorage[key];
        };
        
        window.GM_cookie = undefined;
    </script>
    
    <!-- Load and inject mock data -->
    <script>
        fetch('mock-data.json')
            .then(response => response.json())
            .then(mockData => {
                // Validate mock data structure
                if (!mockData.performance || !mockData.investible || !mockData.summary) {
                    throw new Error('Invalid mock data structure');
                }
                
                GM_setValue('api_performance', JSON.stringify(mockData.performance));
                GM_setValue('api_investible', JSON.stringify(mockData.investible));
                GM_setValue('api_summary', JSON.stringify(mockData.summary));
                
                // Store performance time-series data for each goal
                if (mockData.performanceTimeSeries) {
                    Object.keys(mockData.performanceTimeSeries).forEach(goalId => {
                        const tsKey = `gpv_performance_${goalId}`;
                        const tsData = mockData.performanceTimeSeries[goalId];
                        GM_setValue(tsKey, JSON.stringify({
                            fetchedAt: Date.now(),
                            response: tsData
                        }));
                    });
                    console.log('[Demo] Performance time-series data loaded for', Object.keys(mockData.performanceTimeSeries).length, 'goals');
                }
                
                // Verify data was stored
                if (!GM_getValue('api_performance') || !GM_getValue('api_investible') || !GM_getValue('api_summary')) {
                    throw new Error('Failed to store mock data');
                }
                
                console.log('[Demo] Mock data loaded - House Purchase and Retirement buckets with core-satellite strategy');
                console.log('[Demo] Goals loaded:', mockData.performance.length);
                
                // Load userscript after data is ready
                const script = document.createElement('script');
                script.src = 'goal_portfolio_viewer_demo.user.js';
                script.onerror = function() {
                    console.error('[Demo] Failed to load userscript');
                    document.body.innerHTML = '<div style="padding: 20px; color: red; font-family: sans-serif;">Error loading userscript. Please refresh the page.</div>';
                };
                document.body.appendChild(script);
            })
            .catch(error => {
                console.error('[Demo] Failed to load mock data:', error);
                document.body.innerHTML = '<div style="padding: 20px; color: red;">Error loading demo: ' + error.message + '</div>';
            });
    </script>

</body>
</html>

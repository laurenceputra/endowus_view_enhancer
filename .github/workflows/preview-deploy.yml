name: Deploy Preview (Workers)

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy-preview:
    name: Deploy preview worker
    runs-on: ubuntu-latest
    if: >-
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    concurrency:
      group: preview-${{ github.event.pull_request.head.ref || github.ref_name }}
      cancel-in-progress: true
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      SYNC_KV_ID: ${{ secrets.SYNC_KV_ID }}
      SYNC_KV_PREVIEW_ID: ${{ secrets.SYNC_KV_PREVIEW_ID }}
      CORS_ORIGINS: https://app.sg.endowus.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install workers dependencies
        working-directory: workers
        run: npm ci

      - name: Resolve preview config
        id: preview
        shell: bash
        run: |
          set -euo pipefail

          BRANCH_REF="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          BRANCH_SLUG=$(echo "$BRANCH_REF" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-+|-+$//g' | sed -E 's/-+/-/g')
          if [ -z "$BRANCH_SLUG" ]; then
            BRANCH_SLUG="preview"
          fi
          BRANCH_SLUG=$(echo "$BRANCH_SLUG" | cut -c1-40)
          WORKER_NAME="goal-portfolio-sync-${BRANCH_SLUG}"
          KV_NAME="SYNC_KV_${BRANCH_SLUG}"

          echo "branch_slug=$BRANCH_SLUG" >> "$GITHUB_OUTPUT"
          echo "worker_name=$WORKER_NAME" >> "$GITHUB_OUTPUT"
          echo "kv_name=$KV_NAME" >> "$GITHUB_OUTPUT"

      - name: Ensure KV namespace
        id: kv
        working-directory: workers
        shell: bash
        run: |
          set -euo pipefail

          KV_NAME="${{ steps.preview.outputs.kv_name }}"
          if [ -n "${SYNC_KV_ID}" ]; then
            KV_ID="${SYNC_KV_ID}"
          else
            KV_ID=$(npx wrangler kv:namespace list --json | jq -r --arg name "$KV_NAME" '.[] | select(.title==$name) | .id' | head -n1)
          fi

          if [ -z "$KV_ID" ]; then
            KV_ID=$(npx wrangler kv:namespace create "$KV_NAME" --json | jq -r '.id')
          fi

          echo "kv_id=$KV_ID" >> "$GITHUB_OUTPUT"
          if [ -n "${SYNC_KV_PREVIEW_ID}" ]; then
            echo "kv_preview_id=${SYNC_KV_PREVIEW_ID}" >> "$GITHUB_OUTPUT"
          else
            echo "kv_preview_id=$KV_ID" >> "$GITHUB_OUTPUT"
          fi

      - name: Render preview wrangler config
        id: config
        working-directory: workers
        shell: bash
        run: |
          set -euo pipefail

          WORKER_NAME="${{ steps.preview.outputs.worker_name }}"
          KV_ID="${{ steps.kv.outputs.kv_id }}"
          KV_PREVIEW_ID="${{ steps.kv.outputs.kv_preview_id }}"

          sed -e "s|__WORKER_NAME__|$WORKER_NAME|g" \
              -e "s|__KV_ID__|$KV_ID|g" \
              -e "s|__KV_PREVIEW_ID__|$KV_PREVIEW_ID|g" \
              -e "s|__CORS_ORIGINS__|${CORS_ORIGINS}|g" \
              wrangler.preview.toml.template > /tmp/wrangler.preview.toml

          echo "config_path=/tmp/wrangler.preview.toml" >> "$GITHUB_OUTPUT"

      - name: Deploy preview worker
        working-directory: workers
        shell: bash
        run: |
          set -euo pipefail
          npx wrangler deploy --config /tmp/wrangler.preview.toml

      - name: Post preview URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const workerName = '${{ steps.preview.outputs.worker_name }}';
            const body = [
              '### ☁️ Preview Deployment',
              '',
              `Worker: \`${workerName}\``,
              `URL: https://${workerName}.workers.dev`,
              '',
              'CORS origin: https://app.sg.endowus.com'
            ].join('\n');
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body
            });

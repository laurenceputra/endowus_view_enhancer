name: Agent-Based Quality Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master, develop]

jobs:
  staff-engineer-review:
    name: Staff Engineer - Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          echo "üìù Staff Engineer: Checking code quality..."
          npm run lint

      - name: Check for console.log statements
        run: |
          echo "üîç Staff Engineer: Checking for debug statements..."
          if git diff origin/main...HEAD -- '*.js' | grep -E '^\+.*console\.log' | grep -v DEBUG | grep -v __tests__; then
            echo "‚ö†Ô∏è  Warning: Found console.log statements in production code"
            echo "Consider using DEBUG flag or removing them"
          fi
        continue-on-error: true

  qa-engineer-review:
    name: QA Engineer - Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Jest tests
        run: |
          echo "üß™ QA Engineer: Running test suite..."
          npm test -- --coverage

      - name: Check test coverage
        run: |
          echo "üìä QA Engineer: Analyzing test coverage..."
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.lines.pct")
            echo "Test coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < 70" | bc -l) )); then
              echo "‚ö†Ô∏è  Warning: Test coverage below 70%"
            else
              echo "‚úÖ Good test coverage"
            fi
          fi
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/

  devils-advocate-review:
    name: Devil's Advocate - Risk Assessment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for security patterns
        run: |
          echo "üîç Devil's Advocate: Checking for security risks..."
          
          # Check for eval usage
          if git diff origin/main...HEAD -- '*.js' | grep -E '^\+.*eval\('; then
            echo "‚ùå BLOCKING: Found eval() usage - security risk!"
            exit 1
          fi
          
          # Check for innerHTML with user data
          if git diff origin/main...HEAD -- '*.js' | grep -E '^\+.*innerHTML.*='; then
            echo "‚ö†Ô∏è  Warning: Found innerHTML usage - potential XSS risk"
            echo "Verify that user input is properly sanitized"
          fi
          
          # Check for external API calls
          if git diff origin/main...HEAD -- '*.js' | grep -E '^\+.*fetch\(['\''"]https?://(?!.*endowus)'; then
            echo "‚ùå BLOCKING: Found external API call - violates privacy policy!"
            exit 1
          fi
          
          echo "‚úÖ No critical security risks detected"

      - name: Check for financial calculation changes
        run: |
          echo "üîç Devil's Advocate: Checking financial calculations..."
          
          if git diff origin/main...HEAD -- '*.js' | grep -E '^\+.*(calculate|investment|return|growth|percentage)'; then
            echo "‚ö†Ô∏è  Warning: Financial calculation changes detected"
            echo "Ensure:"
            echo "  - Division by zero is handled"
            echo "  - Rounding is consistent"
            echo "  - Negative values are handled correctly"
            echo "  - Manual verification is performed"
          fi

  code-reviewer-review:
    name: Code Reviewer - Final Gates
    runs-on: ubuntu-latest
    needs: [staff-engineer-review, qa-engineer-review, devils-advocate-review]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check version consistency
        run: |
          echo "üî¢ Code Reviewer: Checking version consistency..."
          USERSCRIPT_VERSION=$(grep -oP '@version\s+\K[0-9.]+' tampermonkey/goal_portfolio_viewer.user.js | head -1)
          PACKAGE_VERSION=$(grep -oP '"version":\s*"\K[0-9.]+' package.json)
          
          if [ "$USERSCRIPT_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "‚ùå Version mismatch:"
            echo "  userscript: $USERSCRIPT_VERSION"
            echo "  package.json: $PACKAGE_VERSION"
            exit 1
          else
            echo "‚úÖ Version consistent: $PACKAGE_VERSION"
          fi

      - name: Check for documentation updates
        run: |
          echo "üìö Code Reviewer: Checking documentation..."
          
          if git diff origin/main...HEAD --name-only | grep -E 'tampermonkey/.*\.js$'; then
            if ! git diff origin/main...HEAD --name-only | grep -E '(README|TECHNICAL_DESIGN|TESTING)\.md'; then
              echo "‚ö†Ô∏è  Warning: Code changes without documentation updates"
              echo "Consider updating documentation if behavior changed"
            fi
          fi
        continue-on-error: true

      - name: Summary
        run: |
          echo "‚úÖ Code Reviewer: All quality gates passed!"
          echo ""
          echo "Summary:"
          echo "  ‚úÖ Code quality verified (Staff Engineer)"
          echo "  ‚úÖ Tests passing (QA Engineer)"
          echo "  ‚úÖ Security checks passed (Devil's Advocate)"
          echo "  ‚úÖ Version consistency verified"
          echo ""
          echo "Ready for human review and merge!"

  workflow-metrics:
    name: Workflow Metrics Collection
    runs-on: ubuntu-latest
    needs: [code-reviewer-review]
    if: always()
    steps:
      - name: Collect metrics
        run: |
          echo "üìä Collecting workflow metrics..."
          echo ""
          echo "Workflow Run: ${{ github.run_number }}"
          echo "PR/Commit: ${{ github.event.pull_request.number || github.sha }}"
          echo "Staff Engineer: ${{ needs.staff-engineer-review.result }}"
          echo "QA Engineer: ${{ needs.qa-engineer-review.result }}"
          echo "Devil's Advocate: ${{ needs.devils-advocate-review.result }}"
          echo "Code Reviewer: ${{ needs.code-reviewer-review.result }}"
          echo ""
          
          if [ "${{ needs.code-reviewer-review.result }}" == "success" ]; then
            echo "‚úÖ All agents approved - workflow successful"
          else
            echo "‚ùå Workflow failed - review agent feedback"
          fi
